{
    "contents" : "---\ntitle: \"RTCGA package tutorial\"\nauthor: \"Marcin Kosinski\"\ndate: \"May 5, 2015\"\noutput:\n  html_document:\n    theme: united\n    highlight: tango\n    fig_width: 17\n    fig_height: 10\n    toc: true\n    toc_depth: 4\n    keep_md: true\n    number_sections: true\n---\n\n\n```{r, echo=FALSE}\nlibrary(knitr)\nopts_chunk$set(comment=\"\", message=FALSE, warning = FALSE, tidy.opts=list(keep.blank.line=TRUE, width.cutoff=150),options(width=150), cache=TRUE, eval = FALSE)\n```\n\n\n# Mission\n\nThe Cancer Genome Atlas (TCGA) Data Portal provides a platform for researchers to search, download, and analyze data sets generated by TCGA. It contains clinical information, genomic characterization data, and high level sequence analysis of the tumor genomes[1]. The key is to understand genomics to improve cancer care. \n\nThe RTCGA package offers an easy interface for downloading and integrating variety of the TCGA data using patient barcode key. This allows for easier data acquisition facilitating development of science and improvement of patients' treatment. RTCGA is an open-source R package available to download from Bioconductor[2]. Furthermore, the RTCGA package transforms the TCGA data to a form which is convenient to use with R statistical package. The data transformation can be a part of the statistical analysis pipeline which can be more reproducible with RTCGA.\n\n\n# RTCGA package\n\nMore detail information about this package can be found\nhere [https://github.com/MarcinKosinski/RTCGA](https://github.com/MarcinKosinski/RTCGA).\n\n\n## Installation of the RTCGA package\nTo get started, install the latest version of **RTCGA** from Bioconductor:\n```{r }\n# not there yet\n```\nor use:\n```{r, eval=FALSE}\nif (!require(devtools)) {\n    install.packages(\"devtools\")\n    library(devtools)\n}\ninstall_github(\"MarcinKosinski/RTCGA\")\n```\n\nMake sure you have [rtools](http://cran.r-project.org/bin/windows/Rtools/) installed on your computer.\n\n# Light data management and manipulations\n\nBelow I'll show an example of how to use `RTCGA` package to download `BRCA` cohort data that contains: `clinical` data, `mutations` data, and `rnaseq v2` data. Furthermore, I'll show how to add an information about `MDM2` gene expression from `rnaseq v2` dataset to clinical data. Finally, I'll provide an example on how to add an information about `TP53` `variant classification` and `amino_acid_change_WU` to the `clinical` data - both variables are located in genes `mutations` dataset.\n\n\n## Breast cancer (BRCA) data download\n\nWe will download data from the newest release date.\n\n```{r}\nlibrary(RTCGA)\ndate <- tail( availableDates() ,1 )\n# if server doesn't respond, just try\n# date <- \"2015-04-02\"\n```\n\nWe will need a folder to which we will download data.\n```{r}\ndir.create(\"data\")\n```\n\n\n### Clinical data\n\nLet us download clinical data. Simply use this command\n\n```{r}\ndownloadTCGA( cancerTypes = \"BRCA\", destDir = \"data/\", date = date )\n```\n\n### Rnaseq v2 data\n\nLet us download rnaseq v2 data. Simply use this command\n\n```{r}\ndownloadTCGA( cancerTypes = \"BRCA\", destDir = \"data/\", date = date,\n              dataSet = \"rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data.Level\" )\n```\n\n### Mutations data\n\nLet us download genes' mutations data. Simply use this command\n\n```{r}\ndownloadTCGA( cancerTypes = \"BRCA\", destDir = \"data/\", date = date,\n              dataSet = \"Mutation_Packager_Calls.Level\" )\n```\n\n\n## Untarring data\n\nLet us use the `untar()` function to untar the all downloaded sets.\n\n```{r, warning=FALSE, results='hide'}\n\nlist.files( \"data/\") %>% \n   paste0( \"data/\", .) %>%\n   sapply( untar, exdir = \"data/\" )\n\n```\n\n\n## Removing no longer needed `tar.gz` files\n\n**Note if this command removes all your files in `data` directory, not only `tar.gz` files, you'll need to download data again and `untar` them manually. It has been observed that on small amount of systems this command deletes also all unpacked files.**\n\nAfter datasets are untarred, the `tar.gz` files ar no longer needed and can be deleted.\n\n```{r, results='hide'}\nlist.files( \"data/\") %>% \n   paste0( \"data/\", .) %>%\n   grep( pattern = \"tar.gz\", x = ., value = TRUE) %>%\n   sapply( file.remove )\n```\n\n## Combining data\n\n### Merging Clinical Data and RNA-Seq data\n\nNow, let us add information about **MDM2** expression into the `BRCA.clinical.merged.txt` file. Note that you can pass an abbreviation of the name of a gene as a parameter and then all matching genes will be added (example: for **TP53** 7 genes are added) at the end of `BRCA.clinical.merged.txt` file.\n   \n```{r}\n# mergeTCGA(\n#       clinicalDir = get(paste0(element,\".clin.path\"), envir = .GlobalEnv),\n#       rnaseqDir = get(paste0(element,\".rnaseq.path\"), envir = .GlobalEnv),\n#       genes = c(\"MDM2\")\n#    )\n```\n\n\n# Heavy data management and manipulations\n\n## Available cohorts\n\n```{r}\nlibrary(RTCGA)\n(cohorts <- infoTCGA() %>% \n   names() %>% \n   sub(\"-counts\", \"\", x=.))\n```\n\n\n\n## Downloading data\n\nOne can check what is the newest available date of release of TCGA datasets.\n```{r}\n\ntail( availableDates(), 2 )\ndate <- tail( availableDates() ,1 )\n```\n\nFor that date we can download datasets for **ALL** Cohorts to the\n`data` folder.\n\n### Clinical data\n\nCan be downloaded using default settings. By default the dataset is downloaded from the newest available date of TCGA releases.\n```{r}\n#dir.create( \"data\" )\ndownloadTCGA( cancerTypes = cohorts, destDir = \"data/\", date = date )\n```\n\n\nLet us check the names and sizes of the downloaded files.\n\n```{r}\nfile.info( paste0( \"data/\", grep( x = list.files(\"data/\"), pattern = \"gdac\", value = TRUE )) )[, 1:2]\n```\n\n\n### Mutations data\n\nLet us check if there is Mutations data available for all cancer types.\n\n```{r, cache = FALSE, message=FALSE, warning=FALSE}\nlibrary(RTCGA)\nlibrary(dplyr)\ncheckDataSetsAvailability( cohorts, \n                           pattern = \"Mutation_Packager_Calls.Level\", \n                           date = date) %>%\n   unlist() %>% \n   cat( sep=\"\\n\")\n\n```\n\n\nLet us download it.\n```{r}\nsapply( cohorts, function(element){\ntryCatch({\ndownloadTCGA( cancerTypes = element, \n              dataSet = \"Mutation_Packager_Calls.Level\",\n              destDir = \"data/\", \n              date = date )},\nerror = function(cond){\n   cat(\"Error: Maybe there weren't mutations data for \", element, \" cancer.\\n\")\n}\n)\n})\n```\n\n\nLet us check the names and sizes of the downloaded files.\n\n\n```{r}\nfile.info( paste0( \"data/\", grep( x = list.files(\"data/\"), pattern = \"gdac\", value = TRUE )) )[, 1:2]\n```\n\n### RNA-Seq data\n\nLet us check if there is RNA-Seq data available for all cancer types.\n\n```{r }\n\ncheckDataSetsAvailability( cohorts,\n                        \"rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data.Level\",\n                        date = date ) %>%\n   unlist() %>%  \n   cat( sep=\"\\n\")\n\n```\n\n\nLet us download it.\n\n```{r}\nsapply( cohorts, function(element){\ntryCatch({\ndownloadTCGA( cancerTypes = element, \n              dataSet = \"rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data.Level\",\n              destDir = \"data/\", \n              date = date )},\nerror = function(cond){\n   cat(\"Error: Maybe there weren't rnaseq data for \", element, \" cancer.\\n\")\n}\n)\n}) \n```\n\nLet us check the names and sizes of the downloaded files.\n\n\n```{r}\nfile.info( paste0( \"data/\", grep( x = list.files(\"data/\"), pattern = \"gdac\", value = TRUE )) )[, 1:2] \n```\n\n## Untarring data\n\nLet us use the `untar()` function to untar the all downloaded sets.\n\n```{r, warning=FALSE, results='hide'}\n\nlist.files( \"data/\") %>% \n   paste0( \"data/\", .) %>%\n   sapply( untar, exdir = \"data/\" )\n\n```\n\n\n### Removing no longer needed `tar.gz` files\n\nAfter datasets are untarred, the `tar.gz` files ar no longer needed and can be deleted.\n\n```{r, results='hide'}\nlist.files( \"data/\") %>% \n   paste0( \"data/\", .) %>%\n   grep( pattern = \"tar.gz\", x = ., value = TRUE) %>%\n   sapply( file.remove )\n```\n\n\n\n## Combining data\n\n### Available genes in RNA-Seq data\n\n\nLet us check the available genes names for **ALL** cancers\nin `rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data.Level` datasets\n\n**Note: This is not really necessary!**\n\n\n```{r, cache=FALSE, echo=3:19, eval=FALSE}\n# this is not really necessary\n\n# if (!requireNamespace('htmlwidgets') || packageVersion('htmlwidgets') <= '0.3.2')\n#   devtools::install_github('ramnathv/htmlwidgets')\n# devtools::install_github('rstudio/DT')\n# # then try DT::datatable(iris) as a hello world example\n\n\n\n# addd interactive DT from DT/rstudio package\n# https://github.com/rstudio/DT\n#\n# genes <- list.files( \"data/\") %>%\n#   grep( pattern = \"rnaseqv2__illuminahiseq\", x = ., value = TRUE ) %>%\n#   paste0( \"data/\", . , \"/\") %>%\n#   sapply( function( element ){ \n#      paste0( element, list.files( element ) ) }) %>%\n#   sapply( availableGenesNames ) %>%\n#   .[which( (lapply(., length) > 0) == TRUE ) ] %>%\n#   as.data.frame( ) \n#\n# names(genes) <- cohorts\n# library(DT)\n#\n# datatable( genes , options=list(iDisplayLength = 10) )\n#\n#\n```\n\n### Merging Clinical Data and RNA-Seq data\n\nNow, let us add information about **MDM2** expression into the `.clinical.merged.txt` files,\nfor each cancer type. Note that you can pass an abbreviation of the name of a gene as a parameter and then all matching genes will be added (example: for **TP53** 7 genes are added) at the end of `.clinical.merged.txt` file.\n\n#### Paths to clinical data\n\n```{r}\n\n```\n\n```{r, width.cutoff=120}\n\nsapply( cohorts, function( element ){\n   folder <- grep( paste0( \"(_\",element,\"\\\\.\", \"|\",\"_\",element,\"-FFPE)\", \".*Clinical\"), list.files(\"data/\"),value = TRUE)\n   path <- paste0( \"data/\", folder, \"/\", element, \".clin.merged.txt\")\n   assign( value = path, x = paste0(element, \".clin.path\"), envir = .GlobalEnv)\n}) \n\n```\n\n\n#### Paths to rnaseq data\n\n```{r}\nsapply( cohorts, function( element ){\n   folder <- grep( paste0( \"(_\",element,\"\\\\.\", \"|\",\"_\",element,\"-FFPE)\", \".*rnaseqv2\"), list.files(\"data/\"),value = TRUE)\n   file <- grep( paste0(element, \".*rnaseqv2\"), list.files( paste0( \"data/\",folder ) ),\n                 value = TRUE)\n   path <- paste0( \"data/\", folder, \"/\", file )\n   assign( value = path, x = paste0(element, \".rnaseq.path\"), envir = .GlobalEnv)\n}) \n```\n\n\n```{r, warning=FALSE}\n\n\nsapply( cohorts, function( element ){\n   tryCatch({\n   mergeTCGA(\n      clinicalDir = get(paste0(element,\".clin.path\"), envir = .GlobalEnv),\n      rnaseqDir = get(paste0(element,\".rnaseq.path\"), envir = .GlobalEnv),\n      genes = c(\"MDM2\")\n   )},\n   error=function(cond){\n   cat(\"Error: Maybe there weren't rnaseq data for \", element, \" cancer.\\n\")\n})\n})\n\n\n```\n\n\n\n### Merging Clinical Data and Mutations data\n\n#### Paths to Muations data\n\n\n```{r}\nsapply( cohorts, function( element ){\n   folder <- grep( paste0( \"(_\",element,\"\\\\.\", \"|\",\"_\",element,\"-FFPE)\", \".*Mutation_Packager\"), list.files(\"data/\"),value = TRUE)\n   path <- paste0( \"data/\", folder, \"/\")\n   assign( value = path, x = paste0(element, \".mutations.dir\"), envir = .GlobalEnv)\n})\n```\n\nLet us add information about the **TP53** gene mutations to `*clinical.merged.txt` files.\n\n```{r}\nsapply( cohorts, function( element ){\n   tryCatch({\n   mergeTCGA(\n      clinicalDir = get(paste0(element,\".clin.path\"), envir = .GlobalEnv),\n      mutationDir = get(paste0(element,\".mutations.dir\"), envir = .GlobalEnv),\n      genes = c(\"TP53\")\n   )},\n   error=function(cond){\n   cat(\"Error: Maybe there weren't mutations data for \", element, \" cancer.\\n\")\n})\n})\n\n```\n\n\n\n## Joining all clinical.merged.files into one data set\n\n\n**This part was not checked yet. It might not been correct. It appears there\nare individual column names in most of the cancers**\n\n\n```{r}\nsapply( cohorts, function(element){\n   tryCatch({\n    assign( value = read.delim(get(paste0(element,\".clin.path\"), envir = .GlobalEnv)),\n    x = paste0(element, \".clin.data\"),\n    , envir = .GlobalEnv)\n    dim(get(x = paste0(element, \".clin.data\"),\n    , envir = .GlobalEnv))\n   },\n   error=function(cond){\n   cat(\"Error: Maybe there weren't clinical data for \", element, \" cancer.\\n\")\n})\n})\n```\n\n```{r}\n\n# ClinicalDataNames <- grep( \"clin.data\", x = ls(), value = TRUE )\n# ClinicalDataNames\n# clinicalCombo <- get(ClinicalDataNames[1], envir = .GlobalEnv)\n# cat(ClinicalDataNames, \"\\n\")\n# cat(dim(clinicalCombo), \"\\n\")\n# for( i in seq_along(ClinicalDataNames)[-1]){\n#    clinicalCombo <- full_join( clinicalCombo, \n#                                get(ClinicalDataNames[i], envir = .GlobalEnv), \n#                                by = \"V1\")\n#    cat(ClinicalDataNames[i], \"\\n\")\n#    cat(dim(clinicalCombo), \"\\n\") #different names? but not all :) !)\n# }\n# if one wants to perform for loop or sapply then one\n# NEEDS TO REMEMBER TO CHAGE NAMES EVERy 4th full_join.....\n\nnames(ACC.clin.data)[-1] <- paste0(\"ACC.clin.data\", 2:ncol(ACC.clin.data))\nnames(BLCA.clin.data)[-1] <- paste0(\"BLCA.clin.data\", 2:ncol(ACC.clin.data))\nclinicalCombo <- full_join( ACC.clin.data, BLCA.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, BRCA.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, CESC.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, CHOL.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, COAD.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\n#clinicalCombo <- full_join( clinicalCombo, COADREAD.clin.data, by = \"V1\") COAD + READ\nclinicalCombo <- full_join( clinicalCombo, DLBC.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, ESCA.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\n#clinicalCombo <- full_join( clinicalCombo, FPPP.clin.data, by = \"V1\") # many\nclinicalCombo <- full_join( clinicalCombo, GBM.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\n#clinicalCombo <- full_join( clinicalCombo, GBMLGG.clin.data, by = \"V1\") # gbm + lgg\nclinicalCombo <- full_join( clinicalCombo, HNSC.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, KICH.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\n#clinicalCombo <- full_join( clinicalCombo, KIPAN.clin.data, by = \"V1\") # kich kirc kirp\nclinicalCombo <- full_join( clinicalCombo, KIRC.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, KIRP.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, LAML.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, LGG.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, LIHC.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, LUAD.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, LUSC.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, MESO.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, OV.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, PAAD.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, PCPG.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, READ.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, SKCM.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, STAD.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, TGCT.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, THCA.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, THYM.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, UCEC.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, UCS.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\nclinicalCombo <- full_join( clinicalCombo, UVM.clin.data, by = \"V1\")\nnames(clinicalCombo)[-1] <- paste0(\"clinicalCombo\", 2:ncol(clinicalCombo))\n\ntable(unlist(as.matrix(clinicalCombo[which(clinicalCombo$V1 == \"admin.disease_code\"),])))\n\n```\n\n\n\nLet us save it into new file \n\n\n```{r}\nfile.create(\"clinicalComboHuge.txt\")\nwrite.table(clinicalCombo,\n            file = \"clinicalComboHuge.txt\",\n            quote = FALSE,\n            sep = \"\\t\",\n            row.names = FALSE)\n```\n\nReimport\n```{r}\nclinicalCombo <- read.clinical(\"clinicalCombo.txt\")\n```\n\n\n\n\n\n",
    "created" : 1431861789734.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2272840599",
    "id" : "F69B6352",
    "lastKnownWriteTime" : 1431865276,
    "path" : "D:/GitHub/RTCGA/index.Rmd",
    "project_path" : "index.Rmd",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "type" : "r_markdown"
}